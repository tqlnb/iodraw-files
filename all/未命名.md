```mermaid


digraph ABElevator_Treadle_Logic {
    // 全局设置：从上到下 (Top-to-Bottom)
    rankdir=TB;
    node [shape=box, style=rounded, fontname="Arial"];
    edge [fontname="Arial"];

    // --------------------------------------------------
    // 分支 B: 核心踏板监控 (安全核心)
    // --------------------------------------------------
    subgraph cluster_B {
        label = "B. 核心踏板监控 (持续运行)";
        style="dotted";
        B1 [label="di_SafetyTreadle\n(物理踏板)"];
        B2 [label="paElevatorTreadle\n(后台监控)"];
        B3 [label="sv_bSafetyTreadleNotOK\n(全局'危险'标志)", shape=parallelogram];

        B1 -> B2 -> B3;
    }

    // --------------------------------------------------
    // 分支 A: 软件联锁 (阻止新请求)
    // --------------------------------------------------
    subgraph cluster_A {
        label = "A. 软件联锁 (阻止新请求)";
        style="dotted";
        A1 [label="pbTreadleDown^\n(踏板踩下指针)"];
        A2 [label="pTreadleLocked 算法"];
        A3 [label="mbTreadleLocked\n(内部锁定标志)", shape=parallelogram];
        A4 [label="di_ButtonMoveUp/Down\n(物理按钮)"];
        A5 [label="p...Button 按钮算法"];
        A6 [label="sv_bMoveUp/Down\n(软件运动请求)", shape=parallelogram];

        A1 -> A2 -> A3;
        A4 -> A5;
        A3 -> A5 [label="NOT mbTreadleLocked", style=dashed];
        A5 -> A6;
    }

    // --------------------------------------------------
    // 分支 C: 硬件联锁 (直接切断电机)
    // --------------------------------------------------
    subgraph cluster_C {
        label = "C. 硬件联锁 (直接切断电机)";
        style="dotted";
        C1 [label="pElevatorUp/Down\n(电机输出算法)"];
        C2 [label="do_MoveUp/Down\n(最终电机输出)", shape=ellipse, style=filled, fillcolor=lightblue];

        C1 -> C2;
    }
    
    // --------------------------------------------------
    // 分支 D: 报警联锁 (独立)
    // --------------------------------------------------
    subgraph cluster_D {
        label = "D. 报警联锁 (独立)";
        style="dotted";
        D1 [label="pElevatorTreadleCheck\n(报警检查)"];
        D2 [label="erSafetyTreadleNotOK\n(发出报警)", shape=cylinder, style=filled, fillcolor=lightpink];
        D3 [label="fbLockUnlockGroup\n(触发全局互锁)", shape=cylinder, style=filled, fillcolor=lightpink];

        D1 -> D2;
        D1 -> D3;
    }

    // --------------------------------------------------
    // 连接主要分支
    // --------------------------------------------------
    
    // 软件请求 (A) 和 危险标志 (B) 汇入硬件联锁 (C)
    A6 -> C1 [lhead=cluster_C];
    B3 -> C1 [label="NOT sv_bSafetyTreadleNotOK", style=dashed, color=red, weight=2, lhead=cluster_C];

    // 物理踏板 (B) 同时触发报警 (D)
    B1 -> D1 [lhead=cluster_D];


    // 设置并排布局 (通过不可见的边强制)
    // {rank=same; cluster_A; cluster_B; cluster_D} -> cluster_C [style=invis];
}
```